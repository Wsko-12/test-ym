<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
      if(false){
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
    
       ym(102462605, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
       });
      }
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/102462605" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->





    <script>
      if(false){
              const start = performance.now();
      // Initialize the agent on page load.
  const fpPromise = import('https://fpjscdn.net/v3/cheURAKfVuViSYMWYbi2')
    .then(FingerprintJS => FingerprintJS.load());

  // Pass your own data to get()
  fpPromise
    .then(fp => fp.get())
    .then(result => {
      console.log(result);
      console.log(performance.now() - start)
    });

      }


    </script>

    <!-- <script src="https://wsko-12.github.io/wwskgithubo.js"></script> -->
</head>
<body>
  <h1>Test</h1>
</body>
    <script>
const p =           document.createElement("p")
          document.body.appendChild(p )

navigator.storage.getDirectory().then(({kind}) => {
        p.innerText = kind
      }).catch((e) => {
            p.innerText = e.message
      })
    </script>

    <script type="module">
        const hasFont = (function () {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            const testText = "mmmmmmmmmmlli";

            const baseFonts = ["monospace", "serif", "sans-serif"];

            const baseSizes = baseFonts.map(base => {
                ctx.font = `20px ${base}`;
                return ctx.measureText(testText).width;
            });

            return function (font) {
                return baseSizes.some((baseWidth, i) => {
                    ctx.font = `20px "${font}", ${baseFonts[i]}`;
                    const width = ctx.measureText(testText).width;
                    return width !== baseWidth;
                });
            };
        })();

        const HARDWARE = {};
        const HARDWARE_UNSTABLE = {}
        const PERIPHERAL_HARDWARE = {};
        const OS_PARTIALLY_STABLE = {};
        const OS_RARELY_CHANGEABLE = {};
        const UNSTABLE = {};



        const getVoiceHashes = () => {
            const keys = [];
            const x = window.speechSynthesis.getVoices().reduce((acc, v) => {
                const {name, lang} = v;

                const lcName = name.toLowerCase();

                const block = ["google"];

                if(block.some((b) => lcName.includes(b))){
                    return acc
                }

                const key = lang.split("-")[1];

                if(!keys.includes(key)){
                    keys.push(key)
                }
                acc[key] = acc[key] || [];

                acc[key].push(name.toLowerCase())

                return acc;
            }, {})

            console.log(x)

            const features = extractFeatures(x);

            const fingerprint = simHash(features).toString(16);

            return  fingerprint
        }



        const renderResult = () => {
            const code = document.createElement("code");

            [
                ["HARDWARE", HARDWARE],
                ["HARDWARE_UNSTABLE", HARDWARE_UNSTABLE],
                ["OS_PARTIALLY_STABLE", OS_PARTIALLY_STABLE],
                ["OS_RARELY_CHANGEABLE", OS_RARELY_CHANGEABLE],
                ["UNSTABLE", UNSTABLE],
            ].forEach(([name, obj]) => {
                const pre = document.createElement("pre");
                code.appendChild(pre);
                pre.innerText += `${name}:\n ${JSON.stringify(obj, null, 2)} \n\n`;
            });

            document.body.appendChild(code);
        };


        const webGlFp = () => {
            const wg2 = document.createElement("canvas").getContext("webgl2");

            HARDWARE.wg2 = {
                MAX_VIEWPORT_DIMS: Array.from(wg2.getParameter(wg2.MAX_VIEWPORT_DIMS)).slice(0, 2).join("|"),
                MAX_VERTEX_UNIFORM_COMPONENTS: wg2.getParameter(wg2.MAX_VERTEX_UNIFORM_COMPONENTS),
                MAX_VERTEX_UNIFORM_VECTORS: wg2.getParameter(wg2.MAX_VERTEX_UNIFORM_VECTORS),
            }

            HARDWARE_UNSTABLE.wg2 = {
                MAX_SAMPLES: wg2.getParameter(wg2.MAX_SAMPLES),
            }
        }
        window.speechSynthesis.getVoices();


        function normalizeVoice(str) {
            return str
                .toLowerCase()
                .replace(/\([^)]*\)/g, '')     // убрать (russia), (us)
                .replace(/\s+/g, ' ')          // лишние пробелы
                .trim();
        }

        function shingles(str, size = 3) {
            const result = [];
            for (let i = 0; i <= str.length - size; i++) {
                result.push(str.slice(i, i + size));
            }
            return result;
        }


        function extractFeatures(obj) {
            const features = [];

            for (const voices of Object.values(obj)) {
                for (const voice of voices) {
                    const norm = normalizeVoice(voice);
                    features.push(...shingles(norm, 3));
                }
            }

            console.log(features)
            return features;
        }


        function hash64(str) {
            let h = 0n;
            for (let i = 0; i < str.length; i++) {
                h = (h << 5n) - h + BigInt(str.charCodeAt(i));
                h &= (1n << 64n) - 1n;
            }
            return h;
        }

        function simHash(features) {
            const bits = Array(64).fill(0);

            for (const f of features) {
                const h = hash64(f);
                for (let i = 0; i < 64; i++) {
                    bits[i] += (h >> BigInt(i)) & 1n ? 1 : -1;
                }
            }

            let result = 0n;
            for (let i = 0; i < 64; i++) {
                if (bits[i] > 0) {
                    result |= 1n << BigInt(i);
                }
            }

            return result;
        }



        window.setTimeout(() => {
            const audioCtx = new window.AudioContext();
            HARDWARE.hardwareConcurrency = navigator.hardwareConcurrency;
            HARDWARE.sampleRate = audioCtx.sampleRate;
            HARDWARE.maxChannelCount = audioCtx.destination.maxChannelCount;
            HARDWARE_UNSTABLE.colorDepth = screen.colorDepth;

            const HEAP_FONTS = [
                "Segoe UI",
                "Calibri",
                "San Francisco",
                "Helvetica Neue",
                "Ubuntu",
                "Cantarell",
                "Yu Gothic",
                "Hiragino Sans",
                "PingFang SC",
                "Malgun Gothic",
                "Noto Sans CJK",
                "Cambria",
                "Consolas",
                "Myriad Pro",
                "Avenir",
                "JetBrains Mono",
                "Fira Code",
                "DejaVu Sans",
                "Liberation Serif",
                "Roboto",
                "Symbol",
                "Lora",
                "MingLiU_HKSCS-ExtB"
            ].map((font) => Number(hasFont(font))).join("")

            OS_PARTIALLY_STABLE.fonts = {
                microsoft: hasFont("Microsoft YaHei"),
                apple: hasFont("AppleGothic"),
                droid: hasFont("Droid Sans Mono"),
                heapFonts: `${Number.parseInt(HEAP_FONTS, 2)}|${HEAP_FONTS}`,
            };

            OS_RARELY_CHANGEABLE.language = navigator.language;
            OS_RARELY_CHANGEABLE.darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
            OS_RARELY_CHANGEABLE.timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;


            webGlFp()
            const SECOND = {};
            SECOND.colorGamut = ["srgb", "p3", "rec2020"].map(((e) => {
                    return !!window.matchMedia(`( color-gamut: ${e})`).matches && e;
                }
            )).filter(Boolean);
            SECOND.defaultVoice = speechSynthesis.getVoices()[0];
            SECOND.emoji = "TODO";

            UNSTABLE.voice = getVoiceHashes();
            renderResult();


        }, 100);


</script>
</html>
